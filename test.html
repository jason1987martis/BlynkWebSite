<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Blynk Web Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --emerald: #0effa8;
      --seafoam: #82ffd5;
      --emerald-bg: #0a1013;
      --emerald-card: rgba(19,36,34, 0.35);
      --emerald-border: rgba(14,255,168,0.23);
      --emerald-shadow: 0 8px 38px 0 rgba(0,255,128,0.16);
      --emerald-soft: #1f2937;
      --emerald-muted: #82ffd5;
      --emerald-text: #e5e7eb;
      --emerald-danger: #ef4444;
    }
    html, body { height:100%; }
    body {
      min-height: 100vh;
      margin: 0;
      font-family: 'Inter', Arial, sans-serif;
      background: var(--emerald-bg);
      background-image: url('data:image/svg+xml;utf8,<svg width="1600" height="900" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="black"/><g stroke="rgb(14,255,168)" stroke-width="3" opacity="0.89"><polyline points="120,90 300,90 420,210"/><polyline points="700,500 800,390 950,390"/><circle cx="420" cy="210" r="12" fill="rgb(14,255,168)" opacity="0.5"/><circle cx="950" cy="390" r="12" fill="rgb(14,255,168)" opacity="0.5"/><polyline points="310,680 700,500"/><polyline points="310,680 420,760"/><polyline points="1150,210 1300,90"/><circle cx="1300" cy="90" r="10" fill="rgb(14,255,168)" opacity="0.3"/><polyline points="420,210 700,500"/><polyline points="1150,210 950,390"/><circle cx="1150" cy="210" r="8" fill="rgb(14,255,168)" opacity="0.3"/></g><g stroke="rgb(14,255,168)" stroke-width="1.2" opacity="0.53"><line x1="720" y1="300" x2="800" y2="90"/><line x1="640" y1="680" x2="1300" y2="350"/><line x1="420" y1="760" x2="700" y2="820"/><line x1="120" y1="90" x2="200" y2="850"/></g></svg>');
      background-size: cover;
      background-position: center;
    }
    header {
      background: var(--emerald-card);
      border: 2px solid var(--emerald-border);
      border-radius: 24px;
      box-shadow: var(--emerald-shadow);
      backdrop-filter: blur(14px) saturate(160%);
      -webkit-backdrop-filter: blur(14px) saturate(160%);
      margin: 48px auto 24px auto;
      padding: 28px 38px 18px 38px;
      max-width: 480px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 18px;
      position: relative;
      z-index: 2;
    }
    .emerald-title {
      text-align: center;
      color: var(--emerald);
      margin-top: 0;
      margin-bottom: 18px;
      font-size: 2rem;
      font-weight: bold;
      letter-spacing: 1px;
      text-shadow: 0 0 12px #10d98048;
    }
    .emerald-row {
      display: flex;
      gap: 14px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0;
    }
    .emerald-input-group {
      display: flex;
      align-items: center;
      width: 100%;
      margin-bottom: 12px;
      position: relative;
    }
    .emerald-input-group input {
      width: 100%;
      padding: 15px 40px 15px 18px;
      background: rgba(14,255,168,0.09);
      border-radius: 999px;
      border: 1.5px solid rgba(14,255,168,0.29);
      color: var(--emerald);
      font-size: 1.1rem;
      outline: none;
      box-sizing: border-box;
      transition: border 0.14s;
    }
    .emerald-input-group input:focus {
      border: 1.8px solid var(--emerald);
      background: rgba(14,255,168,0.15);
    }
    .emerald-input-group .icon {
      position: absolute;
      right: 18px;
      color: var(--emerald);
      font-size: 1.35em;
      opacity: 0.80;
      top: 50%;
      transform: translateY(-50%);
      text-shadow: 0 0 8px #0effa8a6;
      pointer-events: none;
    }
    .emerald-input-group input::placeholder {
      color: var(--seafoam);
      opacity: 0.7;
    }
    .emerald-btn {
      width: 100%;
      margin: 10px 0 0 0;
      color: #11281f;
      font-weight: bold;
      font-size: 1.1rem;
      padding: 13px 0;
      background: linear-gradient(90deg,var(--emerald) 70%,var(--seafoam) 100%);
      border: none;
      border-radius: 28px;
      cursor: pointer;
      transition: opacity .15s;
      box-shadow: 0 2px 14px #10d98042;
    }
    .emerald-btn:hover { opacity: 0.94; }
    .emerald-badge {
      font-size:12px; color:var(--seafoam); background:rgba(14,255,168,0.13); border-radius:999px; padding:2px 8px;
      margin-left: 8px;
    }
    #status {
      font-size:13px; color:var(--seafoam);
      text-align: right;
      margin-top: 2px;
      margin-bottom: -8px;
    }
    #status::before {
      content:"● ";
      color: var(--emerald-danger);
      transition: color .3s;
    }
    #status.connected::before { color: var(--emerald); }
    main {
      max-width: 540px;
      margin: 0 auto 40px auto;
      padding: 0 8px;
    }
    .hint {
      font-size:12px;
      color:var(--seafoam);
      margin-bottom:10px;
      text-align: center;
      text-shadow: 0 0 6px #0effa82a;
    }
    .section {
      background: var(--emerald-card);
      border: 1.5px solid var(--emerald-border);
      border-radius: 18px;
      padding: 20px;
      margin-bottom: 18px;
      box-shadow: var(--emerald-shadow);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .section:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px #0effa82a;
    }
    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap:16px;
      align-items:stretch;
    }
    .card {
      background: linear-gradient(145deg,#0e1627,#161f35);
      border:1.5px solid var(--emerald-border);
      border-radius:14px;
      padding:16px;
      transition: transform .2s, box-shadow .2s;
      color: var(--emerald-text);
    }
    .card:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 20px #0effa82a;
    }
    .card h3 { margin:0 0 6px; font-size:14px; color:var(--seafoam);}
    .kv { font-size:12px; color:var(--seafoam); font-family:monospace; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:space-between; }
    .pill { display:inline-flex; padding:2px 8px; border-radius:999px; background:rgba(14,255,168,0.13);
      color:var(--seafoam); font-size:11px;}
    input[type="range"] {
      -webkit-appearance:none;
      width:100%;
      height:6px;
      border-radius:4px;
      background:#2a3448;
      outline:none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance:none;
      width:16px; height:16px;
      border-radius:50%;
      background:var(--emerald);
      cursor:pointer;
      transition:box-shadow .2s;
    }
    input[type="range"]::-webkit-slider-thumb:hover {
      box-shadow:0 0 0 6px rgba(14,255,168,0.25);
    }
    @media (max-width: 600px) {
      header { max-width: 99vw; padding: 18px 4vw 12px;}
      main { max-width: 99vw; }
    }
  </style>
</head>
<body>
  <header>
    <div class="emerald-title">Blynk Server Connecter</div>
    <div class="emerald-input-group">
      <input id="server" placeholder="Server (e.g. 172.16.2.32)" size="20" />
      <span class="icon">&#128421;</span>
    </div>
    <div class="emerald-input-group">
      <input id="token" placeholder="Auth Token" size="30" />
      <span class="icon">&#128273;</span>
    </div>
    <button id="connectBtn" class="emerald-btn">Connect</button>
    <div class="emerald-row">
      <span id="modes" class="emerald-badge">API: write=?, read=?</span>
      <div id="status">idle</div>
    </div>
  </header>
  <main>
    <div class="hint">
      Tries <code>http://&lt;server&gt;:8080</code> → <code>https://&lt;server&gt;:9443</code> • Loads <code>/projects</code> •
      Writes via <b>/hardware</b> with fallbacks • Reads via <b>/get</b>, <b>/external/api/get</b>, <b>hardware vr</b>.
      Auto-polls every 2s.
    </div>
    <div id="projectsWrap"></div>
  </main>
  <script>
  // ...existing logic, unchanged...
  const els = {
    server: document.getElementById('server'),
    token: document.getElementById('token'),
    connectBtn: document.getElementById('connectBtn'),
    status: document.getElementById('status'),
    modes: document.getElementById('modes'),
    projectsWrap: document.getElementById('projectsWrap')
  };
  let baseURL = "", pollTimer = null;
  const REFRESH_MS = 2000;
  let WRITE_MODE = null, READ_MODE = null;

  try {
    const saved = JSON.parse(localStorage.getItem('blynk_web_cfg_rugged') || "{}");
    if(saved.server) els.server.value = saved.server;
    if(saved.token) els.token.value = saved.token;
    if(saved.wm) WRITE_MODE = saved.wm;
    if(saved.rm) READ_MODE = saved.rm;
    showModes();
  } catch {}

  function setStatus(t){ els.status.textContent = t; }
  function showModes(){ els.modes.textContent = `API: write=${WRITE_MODE||'?'}, read=${READ_MODE||'?'}`; }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
  function saveCfg(){ localStorage.setItem('blynk_web_cfg_rugged', JSON.stringify({
    server: els.server.value.trim(), token: els.token.value.trim(), wm: WRITE_MODE, rm: READ_MODE })); }
  function bases(){
    const h = els.server.value.trim(); if(!h) return [];
    return [`http://${h}:8080`,`https://${h}:9443`,`http://${h}:9443`];
  }
  async function tryFetch(url,opts={}){const res=await fetch(url,{cache:'no-store',...opts});if(!res.ok)throw new Error(`${res.status} ${res.statusText}`);return res;}
  async function tryJSON(url,opts={}){const res=await tryFetch(url,opts);const ct=res.headers.get('content-type')||'';if(ct.includes('application/json'))return res.json();const txt=await res.text();try{return JSON.parse(txt);}catch{return txt;}}
  function escapeHTML(s){return String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

  function normPrefix(t){const x=(t||'').toString().toUpperCase(); if(x==='V'||x==='VIRTUAL')return'V'; if(x==='D'||x==='DIGITAL')return'D'; if(x==='A'||x==='ANALOG')return'A'; return'';}
  function extractPinString(w){if(!w)return''; if(typeof w.pin==='string'&&/^[VDA]\d+$/i.test(w.pin))return w.pin.toUpperCase();
    const arr=Array.isArray(w.pins)&&w.pins.length?w.pins[0]:null;const pNum=(w.pin??(arr?arr.pin:undefined));
    const pType=(w.pinType??w.pin_type??(arr?arr.pinType:undefined));const pref=normPrefix(pType);
    if(pref&&pNum!==undefined)return`${pref}${pNum}`;if(w.dataStreamId!==undefined)return`V${w.dataStreamId}`;
    const maybe=(w.attachedPin||w.datastream||'').toString().toUpperCase();if(/^[VDA]\d+$/.test(maybe))return maybe;return'';}
  function pinToHW(pin){const m=pin.match(/^([VDA])(\d+)$/i); if(!m)return null;const t=m[1].toUpperCase(),n=m; return {cmd:t==='V'?'vw':(t==='D'?'dw':'aw'),num:n};}

  async function resolveBaseAndFetchProjects(){
    const token=els.token.value.trim(); if(!token) throw new Error('Auth token required.');
    const eps=[(b)=>`${b}/${token}/projects`,(b)=>`${b}/${token}/project`,(b)=>`${b}/${token}/dashboard`];
    for(const b of bases()){for(const mk of eps){try{setStatus(`Trying ${mk(b)} ...`);const data=await tryJSON(mk(b));const projs=normalizeProjects(data);if(projs.length){baseURL=b;setStatus(`Connected via ${baseURL}`);els.status.classList.add('connected');return projs;}}catch(e){}}}
    throw new Error(`Could not fetch projects.`);
  }
  function normalizeProjects(raw){if(!raw)return[];if(Array.isArray(raw))return raw.map((p,i)=>({id:p.id??i,name:p.name||p.projectName||`Project ${i+1}`,widgets:widgetsOf(p)}));return[{id:raw.id??0,name:raw.name||raw.projectName||raw.title||'Project',widgets:widgetsOf(raw)}];}
  function widgetsOf(p){if(!p)return[];if(Array.isArray(p.widgets))return p.widgets;const all=[];if(Array.isArray(p.devices))for(const d of p.devices)if(Array.isArray(d.widgets))all.push(...d.widgets);if(Array.isArray(p.tabs))for(const t of p.tabs)if(Array.isArray(t.widgets))all.push(...t.widgets);return all;}

  function renderProjects(projects){const wrap=els.projectsWrap;wrap.innerHTML='';projects.forEach((proj,pi)=>{const sec=document.createElement('section');sec.className='section';sec.innerHTML=`<div class="row"><div><h3 style="margin:0 0 2px 0">${escapeHTML(proj.name)}</h3><div class="kv">Widgets: ${proj.widgets.length}</div></div><span class="pill">Project ID: ${proj.id}</span></div><div class="grid" id="grid-${pi}"></div>`;wrap.appendChild(sec);const grid=sec.querySelector(`#grid-${pi}`);proj.widgets.forEach(w=>grid.appendChild(renderWidget(w)));});}
  function renderWidget(w){const card=document.createElement('div');card.className='card';const label=escapeHTML(w.label||w.name||'Widget');const type=(w.type||w.widgetType||'').toUpperCase();const pin=extractPinString(w);card.dataset.pin=pin||'';card.innerHTML=`<div class="row"><h3>${label}</h3><span class="pill">${type||'UNKNOWN'}${pin?` • ${pin}`:''}</span></div><div class="content"></div>`;return card;}

  async function connectAndLoad(){
    saveCfg(); setStatus('Connecting...'); els.status.classList.remove('connected');
    try{const projects=await resolveBaseAndFetchProjects();renderProjects(projects);setStatus(`Connected: ${baseURL}`);els.status.classList.add('connected');showModes();}
    catch(e){console.error(e);setStatus(`Error: ${e.message}`);els.status.classList.remove('connected');alert(e.message);}
  }
  els.connectBtn.addEventListener('click',connectAndLoad);
  [els.server, els.token].forEach(i=>i.addEventListener('keydown',e=>{if(e.key==='Enter') connectAndLoad()}));
  </script>
</body>
</html>